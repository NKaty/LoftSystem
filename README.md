# LoftSystem
Koa, Mongoose, Socket.io, Redis

Изменения на фронтенд вносились там, где они влияли на реализацию бекэнда. Во всех остальных случаях посылается json с сообщением об ошибки, который фронтенд мог бы обработать.

Изменения, внесенные во фронтенд:
1. Добавлен header в запросы с json Content-Type: application/json - для решения проблемы с koa-body (Content-Type был text/plain, и koa-body его не парсил).
2. Добален в fetch credentials: 'include' - для передачи cookies на бекэнд - иначе не срабатывал метод passport.deserializeUser.
3. Переделан logout - чтобы на бекэнд посылался POST запрос и можно было корректно завершить сессию.
4. В реализации чата убрана опция transportOptions: { polling: extraHeaders: {'username': this.$store.state.user.username} за ненадобностью, чтобы происходил upgrade на websocket (данные о пользователе получаются через сессию и passport).
5. В реализации чата добавлен слушатель на событие error на socket - чтобы, если у пользователя сайт открыт без активности больше времени, чем время жизни cookies, при попытки пользования чатом его выбрасывало на страницу логина (для повторного входа на сайт). Для остальных страниц с сервера приходит сообщение в json о истечении сессии.
6. Изменена логика создания сокетов - теперь новые сокеты не создаются каждый раз при входе на вкладку чата, а используется существующий, если он есть.
7. В связи с п.6 добавлено новые события exit и refresh users. Exit эмитируется сервером при выходе пользователя из приложения,а на клиенте по этому событию происходи disconnect сокета. По refresh user происходит обновление списка пользователей чата при переходе на другие вкладки и обратно (иначе теряется список пользователей на фронтенде).
